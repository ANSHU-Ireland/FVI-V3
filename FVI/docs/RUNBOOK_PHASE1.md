# FVI Phase 1 Runbook

## Overview
This runbook defines the exact data processing, cleaning, and derivation logic for FVI Phase 1.
Target countries: {IND, CHN, USA, JPN, ZAF}

## Reference Year Determination

1. Build set of available years from time-series files for the five target countries
2. Compute intersection across emissions, coal consumption TWh, electricity from coal %
3. If intersection is empty:
   - Select latest year Y that appears in ≥80% of files
   - For remaining files, use latest ≤ Y and mark data_quality -= 0.2
4. Persist reference_year: Y into artifacts/logs/run_meta.json

## File-Specific Cleaning Contracts

### annual-co2-emission.csv
- **Filter**: Code ∈ {IND, CHN, USA, JPN, ZAF}
- **Columns**: Code→iso3, Year→year, Annual CO₂ emissions from coal→emissions_raw
- **Units**: If in Mt, multiply by 1e6 → emissions_tco2e
- **Year Filter**: year == Y or latest ≤ Y (quality -0.2 if fallback)
- **Quality**: Add dataset_id
- **NA Policy**: Skip rows with missing emissions

### Coal Consumption by Countries (Year Wise).xlsx
- **Sheet**: coal-consumption-by-country-ter
- **Filter**: Entity mapping to target ISO-3 codes
- **Columns**: Entity→iso3 (via mapping), Year→year, Coal consumption - TWh→coal_consumption_twh
- **Year Filter**: Y or latest ≤ Y
- **Quality**: Add dataset_id
- **NA Policy**: Skip rows with missing consumption values

### Electricity generated by coal.xlsx (WDI-style)
- **Series**: "Electricity production from coal sources (% of total)"
- **Transform**: Melt wide format to long (iso3, year, value_pct)
- **Filter**: Country Code to target five ISO-3; year to Y or ≤ Y
- **Range**: Clamp to [0, 100]
- **Quality**: Add dataset_id
- **NA Policy**: Skip missing percentages

### global_mining_area_per_country_v1.csv
- **Filter**: ISO3_CODE to the five target countries
- **Columns**: AREA→mining_area_km2, N_FEATURES→mining_sites_count
- **Quality**: Add dataset_id
- **NA Policy**: Use 0 for missing counts, skip missing areas

### New_Deforestation_Fronts_wgs[1].csv
- **Columns**: Name, Area_ha
- **Transform**: Convert ha to km² (divide by 100)
- **Join**: Use deforestation_fronts_country.csv micro-table for mapping
- **Quality**: Add dataset_id
- **NA Policy**: Skip unmapped fronts

### coal-phase-out-timeline.csv
- **Filter**: Code to the five target countries
- **Transform**: Coal Exit Timeline → exit_year
  - "2030s" → 2035
  - "No commitment" → 2100
  - Specific years as-is
- **Quality**: Add dataset_id
- **NA Policy**: Use 2100 for missing commitments

### coal-mining_emissions_sources_ownership_v4_4_0.csv
- **Filter**: ISO-3 column to target countries
- **Computation**: state_ownership_share_pct = 100 × Σ(overall_share_percent where parent_entity_type∈{state,mixed_state}) / Σ(all overall_share_percent)
- **Quality**: Add dataset_id
- **NA Policy**: Use 0 for missing ownership data

### electricity-generation_emissions_sources.csv (optional)
- **Condition**: If both emissions_quantity and activity (MWh-compatible) exist for target ISO-3 and year Y
- **Computation**: intensity_tco2_per_mwh = emissions / activity
- **Quality**: Add dataset_id
- **NA Policy**: Skip if either value missing

## Derivations

### Emissions Pillar (country, Y)

**ES_Absolute**
- Source: emissions_tco2e at Y
- Transform: Log-scaled before normalization
- Quality: Reduce by 0.2 if using fallback year

**ES_Intensity**
- Primary: intensity_tco2_per_mwh from electricity-generation_emissions_sources.csv at Y
- Proxy: emissions_tco2e / (coal_production_twh × 1e6 MWh/TWh) if available
- Quality: Mark proxy_intensity=true, reduce quality by 0.2 for proxy

**ES_CoverageGap**
- Source: coverage_country.csv for {iso3, Y}
- Computation: 100 - coverage_pct
- Missing: Leave as missing if no row exists

### Necessity Pillar (country, Y)

**NEC_CoalShareElec**
- Source: % from coal at Y from electricity file
- Range: [0, 100]

**NEC_ConsumptionLock**
- Source: coal_consumption_twh at Y
- Alternative: Per-capita if population available for Y

**NEC_PopAtRisk**
- Source: Valid % for country × population
- Missing: Leave as missing if no valid source

### Ecological Pillar (country-only)

**Activity Denominator (Phase 1)**
- Primary: coal_electricity (GWh) at Y from Necessity Energy Fulfillment.xlsx::Data
- Fallback: coal_consumption_twh × 1e3 GWh/TWh

**ECO_LandDisturbance**
- Computation: mining_area_km2 / denominator
- Normalize: Higher = worse

**ECO_SiteDensity**
- Computation: mining_sites_count / denominator
- Normalize: Higher = worse

**ECO_DeforestExposure**
- Computation: Sum Area_ha over mapped fronts for country → km²
- Normalize: Divide by global sum over five countries to get share
- Optional: Multiply by country coal activity share

**ECO_AshRisk**
- Source: coal_ash_sites_by_country.csv for iso3
- Computation: (sites + 5×incidents) / denominator
- Missing: Leave as missing if no data

### Artificial Support Pillar (country, Y)

**AS_ExitPenalty**
- Computation: 100 × (exit_year - Y) / (2100 - Y)
- Range: Clip to [0, 100]

**AS_StateOwnership**
- Source: Computed percentage from ownership table

**AS_CoverageGap**
- Source: Same as ES_CoverageGap

**AS_SubsidyProxy**
- Computation: Percentile rank of ES_Absolute across five countries [0-100]
- Use: Only if no direct subsidy data available

## Normalization & Winsorization

1. **Winsorize**: Each continuous sub-metric at [1st, 99th] percentile across five countries
2. **Transform**: For ES_Absolute, apply log transform before min-max
3. **Normalize**: Scale to 0-100 where 100 = worse (except Necessity: 0-100 need index, not inverted)
4. **Storage**: For each sub-metric store:
   - raw_value
   - winsor_low
   - winsor_high  
   - norm_value
   - data_quality
   - dataset_ids

## Dynamic Weight Engine

### Input Collection (Chat Q&A)
- user_iso3 ∈ {IND, CHN, USA, JPN, ZAF}
- depth ∈ {quick, standard, deep}
- persona ∈ {investor, regulator, operator}
- time_horizon ∈ {0-5y, 5-10y, 10-30y}
- risk_tolerance ∈ {low, medium, high}
- capex_band ∈ {none, <50m, 50-200m, >200m}
- policy_exposure ∈ {low, medium, high, unknown}

### Pillar Prior Weights
- Start: w0 = {Emissions: 0.25, Necessity: 0.25, Ecological: 0.25, ArtificialSupport: 0.25}
- Remove pillars with no data for user's country and renormalize

### Persona/Time/Risk Nudges (Additive Deltas)

| Factor | Emissions | Necessity | Ecological | ArtificialSupport |
|--------|-----------|-----------|------------|-------------------|
| persona=investor | +0.20 | +0.00 | +0.05 | +0.15 |
| persona=regulator | +0.25 | +0.10 | +0.20 | +0.25 |
| persona=operator | +0.15 | +0.20 | +0.05 | +0.10 |
| horizon=0-5y | +0.05 | +0.15 | +0.00 | +0.20 |
| horizon=5-10y | +0.10 | +0.10 | +0.10 | +0.10 |
| horizon=10-30y | +0.20 | +0.05 | +0.20 | +0.05 |
| risk=low | +0.20 | +0.10 | +0.15 | +0.20 |
| risk=medium | +0.10 | +0.10 | +0.10 | +0.10 |
| risk=high | +0.00 | +0.15 | +0.05 | +0.00 |
| capex=none | +0.00 | +0.20 | +0.10 | +0.10 |
| capex=<50m | +0.05 | +0.15 | +0.10 | +0.10 |
| capex=50-200m | +0.10 | +0.10 | +0.10 | +0.10 |
| capex=>200m | +0.15 | +0.05 | +0.15 | +0.05 |
| policy=low | +0.10 | +0.00 | +0.05 | +0.25 |
| policy=medium | +0.10 | +0.05 | +0.10 | +0.15 |
| policy=high | +0.15 | +0.10 | +0.10 | +0.10 |

### Depth Scaling and Final Weights
1. α = {quick: 0.7, standard: 1.0, deep: 1.5}[depth]
2. w_logits = w0 + α × (sum of deltas)
3. w = softmax(w_logits)
4. Apply floor: w = max(w, 0.05) elementwise
5. Renormalize to sum=1

### Within-Pillar Subweights
- Start equal across available submetrics
- Optional small persona nudges (±0.05) if depth = deep
- Example: For Emissions, operators prioritize Intensity over Absolute

## Aggregation & Classification

### Scoring
- pillar_score[iso3, P] = average(normalized_submetrics available in P)
- composite = Σ_P w[P] × pillar_score[P]

### Classification Thresholds
- **Sustainable**: composite ≤ 35 AND Emissions ≤ 30 AND (Necessity ≥ 50 OR Ecological ≤ median_of_five)
- **Critical Transition**: 35 < composite ≤ 65 OR (Necessity ≥ 60 and Emissions ≥ 45)
- **Decommission**: composite > 65

### Guardrails
- If ArtificialSupport ≥ 70 AND Emissions ≥ 60 → never Sustainable
- If Ecological ≥ 60 AND Necessity ≤ 30 → bias toward Decommission
- Mark borderline when within ±2 points of threshold

## Validation Gates

### Schema Gate
- Required columns present for each input
- Data types match specifications

### Key Gate
- All rows restricted to {IND, CHN, USA, JPN, ZAF}
- No data leakage from other countries

### Year Gate
- Reference year Y chosen per policy
- List fallbacks per country with penalties applied

### Type/Range Gate
- Percentages in [0, 100]
- No negatives for emissions/activity
- Valid data types

### Outlier Gate
- Winsor bounds recorded
- No NaNs after normalization

### Cross-Checks
- If NEC_CoalShareElec < 5% and NEC_ConsumptionLock top-2 among five → flag inconsistency
- If exit_year ≤ current year but ES_Absolute high → policy mismatch

### Provenance
- Every sub-metric lists dataset_ids
- Weights audit: log priors, deltas, α, floors, final weights
